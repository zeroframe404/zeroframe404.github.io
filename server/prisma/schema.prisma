generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SiniestroTipo {
  choque
  rotura
  robo
}

model Cotizacion {
  id               String   @id @default(uuid()) @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at")
  nombre           String
  telefono         String
  email            String?
  tipoVehiculo     String?  @map("tipo_vehiculo")
  marcaModelo      String?  @map("marca_modelo")
  anio             String?
  localidad        String?
  codigoPostal     String?  @map("codigo_postal")
  uso              String?
  coberturaDeseada String?  @map("cobertura_deseada")
  mensaje          String?
  consentimiento   Boolean
  sourcePage       String   @map("source_page")

  @@index([createdAt(sort: Desc)])
  @@map("cotizaciones")
}

model Contacto {
  id             String   @id @default(uuid()) @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  nombre         String
  telefono       String
  motivoContacto String?  @map("motivo_contacto")
  mensaje        String?
  consentimiento Boolean
  sourcePage     String   @map("source_page")

  @@index([createdAt(sort: Desc)])
  @@index([motivoContacto])
  @@map("contactos")
}

model Siniestro {
  id             String            @id @default(uuid()) @db.Uuid
  createdAt      DateTime          @default(now()) @map("created_at")
  tipo           SiniestroTipo
  nombreReporte  String            @map("nombre_reporte")
  telefono       String
  motivoContacto String            @default("siniestro") @map("motivo_contacto")
  detalleTexto   String?           @map("detalle_texto")
  payloadJson    Json?             @map("payload_json")
  sourcePage     String            @map("source_page")
  archivos       SiniestroArchivo[]

  @@index([createdAt(sort: Desc)])
  @@index([tipo])
  @@index([motivoContacto])
  @@map("siniestros")
}

model SiniestroArchivo {
  id           String    @id @default(uuid()) @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  siniestroId  String    @map("siniestro_id") @db.Uuid
  label        String
  originalName String    @map("original_name")
  mimeType     String    @map("mime_type")
  sizeBytes    Int       @map("size_bytes")
  storageMode  String    @default("db") @map("storage_mode")
  s3Key        String?   @map("s3_key")
  publicUrl    String?   @map("public_url")
  fileData     Bytes?    @map("file_data")
  fileSha256   String?   @map("file_sha256")
  siniestro    Siniestro @relation(fields: [siniestroId], references: [id], onDelete: Cascade)

  @@index([siniestroId])
  @@index([storageMode])
  @@map("siniestro_archivos")
}

model AdminRole {
  id                    String      @id @default(uuid()) @db.Uuid
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  name                  String
  nameNormalized        String      @unique @map("name_normalized")
  canViewCotizaciones   Boolean     @default(false) @map("can_view_cotizaciones")
  canDeleteCotizaciones Boolean     @default(false) @map("can_delete_cotizaciones")
  canViewSiniestros     Boolean     @default(false) @map("can_view_siniestros")
  canDeleteSiniestros   Boolean     @default(false) @map("can_delete_siniestros")
  users                 AdminUser[]

  @@index([name])
  @@map("admin_roles")
}

model AdminUser {
  id                 String         @id @default(uuid()) @db.Uuid
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  username           String
  usernameNormalized String         @unique @map("username_normalized")
  passwordHash       String         @map("password_hash")
  isSuperAdmin       Boolean        @default(false) @map("is_super_admin")
  isActive           Boolean        @default(true) @map("is_active")
  roleId             String?        @map("role_id") @db.Uuid
  role               AdminRole?     @relation(fields: [roleId], references: [id], onDelete: SetNull)
  sessions           AdminSession[]
  activities         AdminActivity[]

  @@index([username])
  @@index([roleId])
  @@map("admin_users")
}

model AdminSession {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  ip        String?
  userAgent String?   @map("user_agent")
  revokedAt DateTime? @map("revoked_at")
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("admin_sessions")
}

model AdminActivity {
  id          String     @id @default(uuid()) @db.Uuid
  createdAt   DateTime   @default(now()) @map("created_at")
  actorUserId String?    @map("actor_user_id") @db.Uuid
  action      String
  section     String?
  targetId    String?    @map("target_id")
  description String
  metadata    Json?
  actorUser   AdminUser? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc)])
  @@index([actorUserId])
  @@index([action])
  @@map("admin_activities")
}
